- name: "install certbot"
  apt:
    name:
      - ssl-cert
      - certbot
    state: present

- name: "get package facts"
  package_facts:

- name: "is apache2 installed?"
  set_fact:
    apache2_installed: "{{ 'apache2' in ansible_facts.packages }}"

- name: "ensure apache is not running"
  service:
    name: apache2
    state: stopped
  when: apache2_installed
  register: apache2_stopped

- name: "get cert for {{ certbot_hostname }}"
  command: >-
    certbot certonly --standalone --domain {{ certbot_hostname }} --cert-name {{ certbot_certname }}
    --non-interactive --quiet --agree-tos {{ certbot_account_options }}
  args:
    creates: "/etc/letsencrypt/live/{{ certbot_certname }}/cert.pem"

- name: "restart apache if it was running originally"
  service:
    name: apache2
    state: started
  when: apache2_stopped.changed

- name: "find certbot dirs"
  find:
    paths:
      - /etc/letsencrypt/live
      - /etc/letsencrypt/archive
    file_type: directory
    recurse: yes
  register: certbotdirs

- name: "set access to top-level certbot dirs for ssl-cert group"
  file:
    path: "{{ item }}"
    owner: root
    group: ssl-cert
    mode: 0750
  loop:
    - /etc/letsencrypt/live
    - /etc/letsencrypt/archive

- name: "set access to second-level certbot dirs for ssl-cert group"
  file:
    path: "{{ item.path }}"
    owner: root
    group: ssl-cert
    mode: 0750
  loop: "{{ certbotdirs.files }}"
  loop_control:
    label: "{{ item.path }}"

- name: "find certbot private keys"
  find:
    paths: /etc/letsencrypt/archive
    patterns: 'priv*.pem'
    recurse: yes
  register: privkeys

- name: "set access to certbot private keys for ssl-cert group"
  file:
    path: "{{ item.path }}"
    owner: root
    group: ssl-cert
    mode: 0640
  loop: "{{ privkeys.files }}"
  loop_control:
    label: "{{ item.path }}"

- name: "create renewal hook for stopping apache"
  copy:
    dest: /etc/letsencrypt/renewal-hooks/pre/apache.sh
    content: |
      #!/bin/bash
      service apache2 stop
    mode: 0755

- name: "create renewal hook for starting apache"
  copy:
    dest: /etc/letsencrypt/renewal-hooks/post/apache.sh
    content: |
      #!/bin/bash
      service apache2 start
    mode: 0755