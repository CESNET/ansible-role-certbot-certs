- name: "install certbot"
  apt:
    name:
      - ssl-cert
      - certbot
    state: present

- name: "check whether cert {{ certbot_certname }} exists"
  stat:
    path: "/etc/letsencrypt/live/{{ certbot_certname }}/cert.pem"
  register: p

- include_tasks:
    file: certbot_create.yml
    apply:
      tags:
        - certbot_certs
  when: not p.stat.exists

- name: "find certbot dirs"
  find:
    paths:
      - /etc/letsencrypt/live
      - /etc/letsencrypt/archive
    file_type: directory
    recurse: yes
  register: certbotdirs

- name: "set access to top-level certbot dirs for ssl-cert group"
  file:
    path: "{{ item }}"
    owner: root
    group: ssl-cert
    mode: 0750
  loop:
    - /etc/letsencrypt/live
    - /etc/letsencrypt/archive

- name: "set access to second-level certbot dirs for ssl-cert group"
  file:
    path: "{{ item.path }}"
    owner: root
    group: ssl-cert
    mode: 0750
  loop: "{{ certbotdirs.files }}"
  loop_control:
    label: "{{ item.path }}"

- name: "find certbot private keys"
  find:
    paths: /etc/letsencrypt/archive
    patterns: 'priv*.pem'
    recurse: yes
  register: privkeys

- name: "set access to certbot private keys for ssl-cert group"
  file:
    path: "{{ item.path }}"
    owner: root
    group: ssl-cert
    mode: 0640
  loop: "{{ privkeys.files }}"
  loop_control:
    label: "{{ item.path }}"

- name: "create renewal pre-hook {{ certbot_prehook }}"
  copy:
    dest: "/etc/letsencrypt/renewal-hooks/pre/{{ certbot_prehook }}"
    src: "{{ certbot_prehook }}"
    mode: 0755

- name: "create renewal post-hook {{ certbot_posthook }}"
  copy:
    dest: "/etc/letsencrypt/renewal-hooks/post/{{ certbot_posthook }}"
    src: "{{ certbot_posthook }}"
    mode: 0755